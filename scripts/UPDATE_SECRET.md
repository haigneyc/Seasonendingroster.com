# UPDATE_SECRET.md ‚Äî Updating `YAHOO_REFRESH_TOKEN` in GitHub Secrets

You only need to do this when the Yahoo **refresh token** changes (rare).  
Most of the time the existing secret keeps working and GitHub Actions will auto-refresh access tokens on each run.

---

## TL;DR (recommended)

After you run `scripts/yahoo_auth_cli.py` and it creates/updates `token.json`:

```bash
# 1) Grab the refresh token from token.json
REFRESH_TOKEN=$(python -c "import json; print(json.load(open('token.json'))['refresh_token'])")

# 2) Set/replace the GitHub secret using the GitHub CLI (gh)
gh secret set YAHOO_REFRESH_TOKEN -R <OWNER>/<REPO> <<< "$REFRESH_TOKEN"
```

> Replace `<OWNER>/<REPO>` (example: `haigneyc/seasonendingroster.com`).  
> You can run this over SSH on your server or any machine with `gh` installed.

---

## Prerequisites

- `token.json` exists and contains `"refresh_token"` (generated by `scripts/yahoo_auth_cli.py`).
- **GitHub CLI** (`gh`) installed and authenticated:
  ```bash
  gh --version
  gh auth login   # choose GitHub.com ‚Üí HTTPS ‚Üí "Login with a web browser"
  ```

---

## Option A ‚Äî Update via GitHub web UI (manual)

1. Go to your repo ‚Üí **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions**.  
2. Click **New repository secret** (or click the secret to **Update** if it exists).
3. Name: `YAHOO_REFRESH_TOKEN`
4. Value: copy the value from `token.json` ‚Üí `refresh_token`. Quick grab:
   ```bash
   python -c "import json; print(json.load(open('token.json'))['refresh_token'])"
   ```
5. **Save**.

---

## Option B ‚Äî Update with GitHub CLI (recommended)

This avoids copy/paste in the browser and handles encryption for you.

```bash
# Extract refresh token from token.json
REFRESH_TOKEN=$(python -c "import json; print(json.load(open('token.json'))['refresh_token'])")

# Set/replace the repo secret (encrypts automatically)
gh secret set YAHOO_REFRESH_TOKEN -R <OWNER>/<REPO> <<< "$REFRESH_TOKEN"

# Verify it's there
gh secret list -R <OWNER>/<REPO> | grep YAHOO_REFRESH_TOKEN
```

- If `gh auth login` hasn‚Äôt been run on this machine, CLI will prompt you.
- `gh secret set` replaces the secret if it already exists.

---

## Option C ‚Äî (Advanced) Update via REST API with a PAT

Only use this if you **cannot** install `gh`. You‚Äôll need:
- A Personal Access Token (classic) with scopes: `repo`, `admin:repo_hook` (or use **fine-grained** PAT with ‚ÄúActions: Read and write secrets‚Äù on the repo).
- `curl`, `jq`, and **libsodium** encryption (or let `python-nacl` do it).

**1) Get the repo‚Äôs public key (for secrets encryption)**

```bash
OWNER=<OWNER>
REPO=<REPO>
PAT=<YOUR_PAT>

curl -s -H "Authorization: Bearer $PAT" \
  https://api.github.com/repos/$OWNER/$REPO/actions/secrets/public-key \
  | tee /tmp/gh_pubkey.json
```

**2) Encrypt your refresh token with that key (Python + pynacl approach)**

```bash
pip install pynacl jq >/dev/null 2>&1 || true  # install if needed

python - <<'PY'
import base64, json, sys
from nacl import public, encoding

data = json.load(open('/tmp/gh_pubkey.json'))
key   = data['key']
key_id= data['key_id']

from_json = json.load(open('token.json'))
secret = from_json['refresh_token'].encode()

pubkey = public.PublicKey(key.encode(), encoding.Base64Encoder())
sealed = public.SealedBox(pubkey).encrypt(secret)
print(json.dumps({"encrypted_value": base64.b64encode(sealed).decode(), "key_id": key_id}))
PY
```

This prints a JSON blob with `encrypted_value` and `key_id`.

**3) Put the secret**

```bash
ENC=$(python - <<'PY'
import base64, json, sys
from nacl import public, encoding
d=json.load(open('/tmp/gh_pubkey.json'))
key=d['key']; key_id=d['key_id']
rt=json.load(open('token.json'))['refresh_token'].encode()
pub=public.PublicKey(key.encode(), encoding.Base64Encoder())
sealed=public.SealedBox(pub).encrypt(rt)
print(base64.b64encode(sealed).decode()+" "+key_id)
PY)

ENCRYPTED_VALUE=$(echo "$ENC" | cut -d' ' -f1)
KEY_ID=$(echo "$ENC" | cut -d' ' -f2)

curl -X PUT \
 -H "Authorization: Bearer $PAT" \
 -H "Accept: application/vnd.github+json" \
 https://api.github.com/repos/$OWNER/$REPO/actions/secrets/YAHOO_REFRESH_TOKEN \
 -d "{\"encrypted_value\":\"$ENCRYPTED_VALUE\",\"key_id\":\"$KEY_ID\"}"
```

If it returns details of the secret, you‚Äôre done.

> **Tip:** Prefer the **GitHub CLI** method when possible‚Äîit‚Äôs safer and simpler.

---

## When do I need to rotate this secret?

- You deleted `token.json` and re-ran `yahoo_auth_cli.py`
- You revoked the Yahoo app or created a new client secret
- The Actions log shows `invalid_grant` or `invalid_refresh_token`

**Rotation steps:**
```bash
python scripts/yahoo_auth_cli.py                   # generates fresh token.json
REFRESH_TOKEN=$(python -c "import json; print(json.load(open('token.json'))['refresh_token'])")
gh secret set YAHOO_REFRESH_TOKEN -R <OWNER>/<REPO> <<< "$REFRESH_TOKEN"
# re-run the workflow from the Actions tab or wait for the next schedule
```

---

## Safety notes

- Never commit `token.json` or `oauth2.json`. Ensure `.gitignore` has:
  ```
  oauth2.json
  token.json
  data/
  __pycache__/
  *.pyc
  ```
- Treat the refresh token like a password.
- If you suspect exposure, generate a new one (run `yahoo_auth_cli.py`) and update the secret.

---
Happy automating! üöÄ