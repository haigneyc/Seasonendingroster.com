<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Franchise Career Stats</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="sitebar">
    <div class="bar-inner">
      <div class="brand">Season Ending Roster</div>
      <nav class="tabs" aria-label="Primary">
        <a href="index.html">Home</a>
        <a href="franchises.html" aria-current="page">Franchises</a>
        <a href="playoffs.html">Playoffs</a>
        <a href="seasons/index.html">Seasons</a>
        <a href="h2h.html">H2H</a>
        <a href="history.html">History</a>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <div class="page-header">
      <h1>Franchise Career Stats</h1>
    </div>

    <div class="controls">
      <input id="q" type="search" placeholder="Filter by franchise owner or team name..." />
      <span class="count" id="counts"></span>
      <a class="btn" id="dlCsv" href="data/processed/franchise_career_stats.csv" download>Download CSV</a>
    </div>

    <div class="small muted mb-2" id="srcNote"></div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="franchise_owner">Franchise</th>
            <th class="right" data-k="seasons">Seasons</th>
            <th class="right" data-k="wins">W</th>
            <th class="right" data-k="losses">L</th>
            <th class="right" data-k="ties">T</th>
            <th class="right" data-k="win_pct">Win %</th>
            <th class="right" data-k="points_for">PF</th>
            <th class="right" data-k="points_against">PA</th>
            <th class="right small" data-k="avg_pf_per_season">Avg PF/Season</th>
            <th data-k="team_names_seen">Team Names Seen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer class="site-footer">
    <div>&copy; 2004&ndash;<span id="yr"></span> Season Ending Roster</div>
    <div class="foot-meta" id="footMeta"></div>
  </footer>

  <script>
    // Set sticky offset
    (function setStickyOffset() {
      function apply() {
        const bar = document.querySelector('.sitebar');
        const h = bar ? Math.ceil(bar.getBoundingClientRect().height) : 60;
        document.documentElement.style.setProperty('--sticky-top', (h + 8) + 'px');
      }
      apply();
      window.addEventListener('resize', apply, { passive: true });
    })();

    document.getElementById('yr').textContent = new Date().getFullYear();

    const CSV_CAND = [
      'data/processed/franchise_career_stats.csv',
      '/data/processed/franchise_career_stats.csv'
    ];
    const METRICS_CAND = [
      'data/processed/metrics.json',
      '/data/processed/metrics.json'
    ];

    const srcNote = document.getElementById('srcNote');
    const footMeta = document.getElementById('footMeta');
    const dlCsv = document.getElementById('dlCsv');

    function num(v) { const n = +v; return Number.isFinite(n) ? n : null; }
    function pct(w, l, t) { const g = (+w || 0) + (+l || 0) + (+t || 0); return g ? (w / g) : 0; }

    async function fetchFirst(paths, asText = false) {
      for (const url of paths) {
        try {
          const r = await fetch(url, { cache: 'no-store' });
          if (r.ok) {
            return asText ? { url, text: await r.text(), headers: r.headers }
                          : { url, json: await r.json(), headers: r.headers };
          }
        } catch {}
      }
      return null;
    }

    // CSV parser
    function parseCSV(text) {
      const rows = []; let i = 0, field = '', row = [], inQ = false;
      function pushField() { row.push(field); field = ''; }
      function pushRow() { rows.push(row); row = []; }
      while (i < text.length) {
        const ch = text[i++];
        if (inQ) {
          if (ch === '"' && text[i] === '"') { field += '"'; i++; }
          else if (ch === '"') { inQ = false; }
          else field += ch;
        } else {
          if (ch === '"') { inQ = true; }
          else if (ch === ',') { pushField(); }
          else if (ch === '\r') { /* skip */ }
          else if (ch === '\n') { pushField(); pushRow(); }
          else field += ch;
        }
      }
      if (field.length || row.length) { pushField(); pushRow(); }
      const head = rows.shift().map(h => h.trim());
      return rows.filter(r => r.length).map(r => {
        const o = {}; head.forEach((h, idx) => o[h] = r[idx] != null ? r[idx] : ''); return o;
      });
    }

    function normalizeCsvRow(r) {
      const owner = r.franchise_owner || r.owner || r.Franchise || r.franchise || '';
      const seasons = num(r.seasons_played) || num(r.seasons) || num(r.Seasons);
      const wins = num(r.wins || r.W), losses = num(r.losses || r.L), ties = num(r.ties || r.T) || 0;
      const pf = num(r.points_for || r.PF), pa = num(r.points_against || r.PA);
      // Compute avg_pf_per_season if not present
      let avg = num(r.avg_pf_per_season || r['Avg PF/Season']);
      if (avg == null && pf != null && seasons != null && seasons > 0) {
        avg = pf / seasons;
      }
      const wn = r.win_pct != null ? +r.win_pct : pct(wins, losses, ties);
      const names = r.team_names_seen || r['Team Names Seen'] || '';
      return { franchise_owner: owner, seasons, wins, losses, ties, win_pct: wn, points_for: pf, points_against: pa, avg_pf_per_season: avg, team_names_seen: names };
    }

    function normalizeJsonRow(r) {
      const owner = r.franchise_owner || r.owner || r.name || '';
      const pf = r.points_for ?? r.pf ?? null;
      const pa = r.points_against ?? r.pa ?? null;
      const names = Array.isArray(r.team_names_seen) ? r.team_names_seen.join('; ') : (r.team_names_seen || r.team_names || '');
      const wins = r.wins ?? r.w ?? null, losses = r.losses ?? r.l ?? null, ties = r.ties ?? r.t ?? 0;
      const seasons = r.seasons_played ?? r.seasons ?? r.years ?? null;
      const win_pct = r.win_pct != null ? +r.win_pct : pct(wins, losses, ties);
      // Compute avg_pf_per_season if not present
      let avg = r.avg_pf_per_season ?? r.avg_pf ?? null;
      if (avg == null && pf != null && seasons != null && seasons > 0) {
        avg = pf / seasons;
      }
      return { franchise_owner: owner, seasons, wins, losses, ties, win_pct, points_for: pf, points_against: pa, avg_pf_per_season: avg, team_names_seen: names };
    }

    function fmt(x) { return x == null || x === '' ? '&mdash;' : String(x); }
    function fmt1(x) { return x == null ? '&mdash;' : Number(x).toFixed(1); }
    function fmtPct(x) { return x == null ? '&mdash;' : (Number(x) * 100).toFixed(1) + '%'; }
    function fmt0(x) { return x == null ? '&mdash;' : Number(x).toLocaleString(); }

    (async function init() {
      let rows = [];
      let src = '';

      // Prefer CSV
      const csv = await fetchFirst(CSV_CAND, true);
      if (csv) {
        const parsed = parseCSV(csv.text).map(normalizeCsvRow);
        if (parsed.length) {
          rows = parsed;
          src = csv.url;
          dlCsv.href = csv.url;
        }
      }

      // Fallback to metrics.json
      if (!rows.length) {
        const mj = await fetchFirst(METRICS_CAND, false);
        const j = mj?.json || {};
        let arr = [];
        if (Array.isArray(j.franchise_career_stats)) arr = j.franchise_career_stats;
        else if (j.leaderboards && Array.isArray(j.leaderboards.franchise_career_stats)) arr = j.leaderboards.franchise_career_stats;
        if (arr.length) {
          rows = arr.map(normalizeJsonRow);
          src = mj.url + ' (metrics.json)';
        }
      }

      const tbody = document.querySelector('#tbl tbody');
      const q = document.getElementById('q');
      const counts = document.getElementById('counts');
      const srcNoteEl = document.getElementById('srcNote');
      if (srcNoteEl) srcNoteEl.textContent = src ? `Loaded from: ${src}` : 'No source found (expected franchise_career_stats.csv).';

      let sortKey = 'win_pct', sortDir = -1, filter = '';

      function applyFilterSort() {
        const filtered = rows.filter(r => {
          if (!filter) return true;
          const hay = (r.franchise_owner || '') + ' ' + (r.team_names_seen || '');
          return hay.toLowerCase().includes(filter.toLowerCase());
        });
        filtered.sort((a, b) => {
          const av = a[sortKey], bv = b[sortKey];
          if (av == null && bv == null) return 0;
          if (av == null) return 1;
          if (bv == null) return -1;
          if (typeof av === 'number' && typeof bv === 'number') return (av - bv) * sortDir;
          return String(av).localeCompare(String(bv)) * sortDir;
        });
        tbody.innerHTML = filtered.map(r => `
          <tr>
            <td>${fmt(r.franchise_owner)}</td>
            <td class="right">${fmt0(r.seasons)}</td>
            <td class="right">${fmt0(r.wins)}</td>
            <td class="right">${fmt0(r.losses)}</td>
            <td class="right">${fmt0(r.ties)}</td>
            <td class="right">${fmtPct(r.win_pct)}</td>
            <td class="right">${fmt0(r.points_for)}</td>
            <td class="right">${fmt0(r.points_against)}</td>
            <td class="right small">${fmt1(r.avg_pf_per_season)}</td>
            <td>${fmt(r.team_names_seen)}</td>
          </tr>
        `).join('');
        counts.textContent = `${filtered.length} franchises`;
      }

      document.querySelectorAll('#tbl thead th[data-k]').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.getAttribute('data-k');
          if (k === sortKey) sortDir *= -1; else { sortKey = k; sortDir = (k === 'franchise_owner' || k === 'team_names_seen') ? 1 : -1; }
          applyFilterSort();
        });
      });
      q.addEventListener('input', () => { filter = q.value.trim(); applyFilterSort(); });

      applyFilterSort();
      footMeta.textContent = rows.length ? `${rows.length} franchises` : '0 rows';
    })();
  </script>
</body>
</html>
